<?php
	include "loghead.php";
?>
<html>
<head>
	<title>Search</title>
</head>

<body>
<div align=center>
<h1>Search Cheats & Exploits</h1>
<p>Search by genre, title, or select a system.</p>
<form method="post" action="search.php">
    <input type="text" id="search" name="search" />
    <input type="submit" value="Search Genre" name="submit" />
</form>
<form method="post" action="search.php">
	<input type="text" id="search2" name="search2" />
    <input type="submit" value="Search Name" name="submit" />
</form>
<form method="post" action="search.php">
	<select name="systems">
		<option value="">Select a System</option>
		<option value="X360">XBOX 360</option>
		<option value="PC">PC</option>
		<option value="MAC">MAC</option>
		<option value="Wii">Wii</option>
		<option value="PS2">Playstation 2</option>
		<option value="PS3">Playstation 3</option>
		<option value="PSP">PSP</option>
	</select>
	<input type="submit" value="Go" name="submit" />
</form>

<?php
	include "db_connect.php";
	if (isset($_POST['search']))
	{
	
		echo "<h2>Results</h2>";
		echo "<div align=center>";
		echo "<table border='1'>";
		echo "<tr><th>Title</th><th>Genre</th><th>*</th></tr>";
  		$searchterm = mysqli_real_escape_string($db, trim($_POST['search']));
		
		$query = "SELECT * from game_list WHERE genre LIKE '%$searchterm%'";
		$result = mysqli_query($db, $query) or die("IT DIED!");
		while($row = mysqli_fetch_array($result))
		{
			$id = $row['id'];
			$game = $row['game_name'];
  			$genre = $row['genre'];
  			$Url = $row['url'];
  			if(!isset($_SESSION['username']))
  			{
				echo "<tr><td><a href='$Url'>$game</a></td><td>$genre</td>";
			}
			else
			{
				$name = $_SESSION['username'];
				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				//Inner join on three tables used to display the favorite/unfavorite buttons
				$query = "SELECT fav.* FROM game_list AS gl 
							INNER JOIN user_favorites AS fav 
							INNER JOIN users AS u
							ON gl.id = fav.game_id
							WHERE fav.user_id = $uid
							AND fav.game_id = $id";
				
				$result4 = mysqli_query($db,$query) or die("BLAST");
				if($row3 = mysqli_fetch_array($result4))
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td><td><a href='unfav.php?gameid=$id'>Unfavorite</a></td></tr>";
				}
				else
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td></td><td><a href='fav.php?gameid=$id'>Favorite</a></td></tr>";
				}
			}
		}
		echo "</table></div>";
	}
	else if (isset($_POST['search2']))
	{
		echo "<h2>Results</h2>";
		echo "<div align=center>";
		echo "<table border='1'>";
		echo "<tr><th>Title</th><th>Genre</th><th>*</th></tr>";
  		$searchterm = mysqli_real_escape_string($db, trim($_POST['search2']));
		
		$query = "SELECT * from game_list WHERE game_name LIKE '%$searchterm%'";
		$result = mysqli_query($db, $query) or die("IT DIED!");
		while($row = mysqli_fetch_array($result))
		{
			$id = $row['id'];
			$game = $row['game_name'];
  			$genre = $row['genre'];
  			$Url = $row['url'];
			
			if(!isset($_SESSION['username']))
  			{
				echo "<tr><td><a href='$Url'>$game</a></td><td>$genre</td>";
			}
			else
			{
				$name = $_SESSION['username'];
				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				$query = "SELECT fav.* FROM game_list AS gl 
							INNER JOIN user_favorites AS fav 
							INNER JOIN users AS u
							ON gl.id = fav.game_id
							WHERE fav.user_id = $uid
							AND fav.game_id = $id";

				$result4 = mysqli_query($db,$query) or die("BLAST");
				if($row3 = mysqli_fetch_array($result4))
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td><td><a href='unfav.php?gameid=$id'>Unfavorite</a></td></tr>";
				}
				else
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td></td><td><a href='fav.php?gameid=$id'>Favorite</a></td></tr>";
				}
			}
		}
		echo "</table></div>";
	}
	else if(isset($_POST['systems']))
	{
		echo "<h2>Results</h2>";
		echo "<div align=center>";
		echo "<table border='1'>";
		echo "<tr><th>Title</th><th>Genre</th><th>*</th></tr>";
		$searchterm = mysqli_real_escape_string($db, trim($_POST['systems']));
		
		$query = "SELECT id FROM systems WHERE sys_name = '$searchterm'";
		$result = mysqli_query($db, $query) or die ("Bad query is bad.");
		
		while($row = mysqli_fetch_array($result))
		{
			$sid = $row['id'];
			$query = "SELECT gl.* FROM game_list AS gl
						INNER JOIN system_matches AS sm
						INNER JOIN systems AS s
						ON gl.id = sm.game_id
						WHERE sm.sys_id = s.id
						AND s.id = $sid";
			$result = mysqli_query($db, $query) or die("IT DIED!");
			
			if(!isset($_SESSION['username']))
  			{
				echo "<tr><td><a href='$Url'>$game</a></td><td>$genre</td>";
			}
			else
			{
				$name = $_SESSION['username'];
				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				$query = "SELECT fav.* FROM game_list AS gl 
							INNER JOIN user_favorites AS fav 
							INNER JOIN users AS u
							ON gl.id = fav.game_id
							WHERE fav.user_id = $uid
							AND fav.game_id = $id";

				$result4 = mysqli_query($db,$query) or die("BLAST");
				if($row3 = mysqli_fetch_array($result4))
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td><td><a href='unfav.php?gameid=$id'>Unfavorite</a></td></tr>";
				}
				else
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td></td><td><a href='fav.php?gameid=$id'>Favorite</a></td></tr>";
				}
			}
		}
	}
?>
</div>
</body>
</html>