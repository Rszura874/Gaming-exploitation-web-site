<?php
	include "loghead.php";
?>
<html>
<body>

<h1>Search Cheats & Exploits</h1>
<p>Search by genre or title.</p>
<form method="post" action="search.php">
    <input type="text" id="search" name="search" />
    <input type="submit" value="Search Genre" name="submit" />
</form>
<form method="post" action="search.php">
	<input type="text" id="search2" name="search2" />
    <input type="submit" value="Search Name" name="submit" />
</form>
<!--<form method="post" action="search.php">
	<input type="text" id="search3" name="search3" />
    <input type="submit" value="Search ID" name="submit" />
</form>-->

<?php
	include "db_connect.php";
	if (isset($_POST['search']))
	{
	?>
	<h2>Results</h2>
	<table border="1">
	<tr><th>Title</th><th>Genre</th><th>*</th></tr>
	<?php
  		$searchterm = mysqli_real_escape_string($db, trim($_POST['search']));
		
		$query = "SELECT * from game_list WHERE genre LIKE '%$searchterm%'";
		$result = mysqli_query($db, $query) or die("IT DIED!");
		while($row = mysqli_fetch_array($result))
		{
			$id = $row['id'];
			$game = $row['game_name'];
  			$genre = $row['genre'];
  			$Url = $row['url'];
  			if(!isset($_SESSION['username']))
  			{
				echo "<tr><td><a href='$Url'>$game</a></td><td>$genre</td>";
			}
			else
			{
				$name = $_SESSION['username'];
				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				$query = "SELECT fav.* FROM game_list AS gl 
							INNER JOIN user_favorites AS fav 
							INNER JOIN users AS u
							ON gl.id = fav.game_id
							WHERE fav.user_id = $uid
							AND fav.game_id = $id";
/*				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				$query = "Select id from game_list where game_name ='$game'";
				$result3 = mysqli_query($db,$query) or die("");
				$row4 = mysqli_fetch_array($result3);
				$gid = $row4['id'];
				$query = "Select * from user_favorites where user_id ='$uid' AND game_id='$gid'";
*/
				
				$result4 = mysqli_query($db,$query) or die("BLAST");
				if($row3 = mysqli_fetch_array($result4))
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td><td><a href='unfav.php?gameid=$id'>Unfavorite</a></td></tr>";
				}
				else
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td></td><td><a href='fav.php?gameid=$id'>Favorite</a></td></tr>";
				}
			}
		}
	}
	else if (isset($_POST['search2']))
	{
	?>
	<h2>Results</h2>
	<table border="1">
	<tr><th>Title</th><th>Genre</th><th>*</th></tr>
	<?php
  		$searchterm = mysqli_real_escape_string($db, trim($_POST['search2']));
		
		$query = "SELECT * from game_list WHERE game_name LIKE '%$searchterm%'";
		$result = mysqli_query($db, $query) or die("IT DIED!");
		while($row = mysqli_fetch_array($result))
		{
			$id = $row['id'];
			$game = $row['game_name'];
  			$genre = $row['genre'];
  			$cUrl = $row['cheat_url'];
  			$eUrl = $row['exploit_url'];
			if(!isset($_SESSION['username']))
  			{
				echo "<tr><td><a href='$Url'>$game</a></td><td>$genre</td>";
			}
			else
			{
				$name = $_SESSION['username'];
				$query = "Select id from users where username='$name'";
				$result2 = mysqli_query($db,$query) or die("NOOOO");
				$row2 = mysqli_fetch_array($result2);
				$uid = $row2['id'];
				$query = "Select id from game_list where game_name ='$game'";
				$result3 = mysqli_query($db,$query) or die("");
				$row4 = mysqli_fetch_array($result3);
				$gid = $row4['id'];
				$query = "Select * from user_favorites where user_id ='$uid' AND game_id='$gid'";
				$result4 = mysqli_query($db,$query) or die("BLAST");
				if($row3 = mysqli_fetch_array($result4))
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td><td><a href='unfav.php?gameid=$id'>Unfavorite</a></td></tr>\n";
				}
				else
				{
					echo "<tr><td><a href='$Url'>$game</a></td><td>
					$genre</td></td><td><a href='fav.php?gameid=$id'>Favorite</a></td></tr>\n";
				}
			}
		}
	}
	//Figured this was superfluous - people unlikely to search by ID number
	/*else if (isset($_POST['search3']))
	{
		$searchterm = mysqli_real_escape_string($db, trim($_POST['search3']));
		
		$query = "SELECT * from game_list WHERE id LIKE '%$searchterm%'";
		$result = mysqli_query($db, $query) or die("IT DIED!");
		while($row = mysqli_fetch_array($result))
		{
			$id = $row['id'];
			$game = $row['game_name'];
  			$genre = $row['genre'];
  			$cUrl = $row['cheat_url'];
  			$eUrl = $row['exploit_url'];
			echo "<tr><td>$id</td><td>$game</td><td>$genre</td><td><a href='$cUrl'>Cheats</a>
			</td><td><a href='$eUrl'>Exploits</a></td></tr>\n";
		}
	}*/
?>
</table>
</body>
</html>